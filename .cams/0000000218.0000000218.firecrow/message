refactor main, starting to address memory leaks