minor refactor mostly working tests